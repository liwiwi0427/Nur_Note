<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†è¨˜éŒ„å¾Œå°ç®¡ç†</title>
    <link rel="stylesheet" href="style.css">
    <script src="database.js"></script>
    <style>
        /* é¿å…èˆ‡èˆŠæ¨£å¼è¡çªçš„å¾®èª¿ */
        body { margin: 0; padding: 0; background-color: #f0f2f5; display: block; }
        input, textarea { background: #f8fafc; border: 1px solid #e2e8f0; }
        input:focus, textarea:focus { background: #fff; border-color: var(--primary); }
    </style>
</head>
<body>

<div class="admin-wrapper">
    
    <!-- å·¦å´å´é‚Šæ¬„ -->
    <div class="sidebar-panel">
        <div class="sidebar-header">
            <div class="sidebar-title">ğŸ©º Admin</div>
            <button class="mini-btn" title="æ–°å¢ä¸»è™•ç½®" onclick="openModal('main')" style="width:30px; height:30px; font-size:16px;">ï¼‹</button>
        </div>
        
        <div class="sidebar-content" id="sidebarTree">
            <!-- JS å°‡æœƒç”¢ç”Ÿæ¨¹ç‹€åœ– -->
        </div>
        
        <div style="padding: 15px; font-size: 12px; text-align: center; color: #64748b; border-top: 1px solid #334155;">
            v2.0 Dashboard
        </div>
    </div>

    <!-- å³å´å…§å®¹å€ -->
    <div class="main-content">
        
        <!-- ç©ºç™½ç‹€æ…‹ (ä¸€é–‹å§‹é¡¯ç¤º) -->
        <div id="emptyState" class="empty-state">
            <div class="empty-icon">ğŸ‘ˆ</div>
            <h2>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹é …ç›®</h2>
            <p>é»æ“Šå·¦å´é¸å–®çš„ã€Œï¼‹ã€å¯æ–°å¢é¡åˆ¥</p>
        </div>

        <!-- ç·¨è¼¯å¡ç‰‡ (é¸ä¸­é …ç›®å¾Œé¡¯ç¤º) -->
        <div id="editorCard" class="editor-card">
            <div class="editor-header">
                <div>
                    <div class="breadcrumb" id="breadcrumbPath">Main > Category</div>
                    <div class="editor-title" id="editorTitle">Foley Insert</div>
                </div>
                <button class="btn-secondary" style="background:#fee2e2; color:#ef4444;" onclick="deleteItem()">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>

            <div class="form-group">
                <label>å…§å®¹æ¨¡ç‰ˆ (Content Template)</label>
                <textarea id="editorContent" style="height: 250px; font-size: 16px; line-height: 1.6;"></textarea>
                <div class="hint">ğŸ’¡ æç¤ºï¼šè¼¸å…¥ {{è®Šæ•¸}} å¯è‡ªå‹•ç”¢ç”Ÿå¡«ç©ºæ¬„ä½ã€‚ä¾‹å¦‚ï¼š{{Size}}</div>
            </div>

            <button class="btn-primary" onclick="saveCurrentItem()">ğŸ’¾ æš«å­˜ä¿®æ”¹</button>
        </div>

    </div>

    <!-- æµ®å‹•ä¸‹è¼‰æŒ‰éˆ• -->
    <button class="fab-save" onclick="downloadDB()">
        ğŸ“¥ ä¸‹è¼‰æ›´æ–°æª”æ¡ˆ
    </button>

</div>

<!-- æ–°å¢ç”¨çš„ Modal -->
<div id="modalOverlay" class="modal modal-overlay">
    <div class="modal-box">
        <h3 id="modalTitle" style="color:var(--text-main); margin-top:0;">æ–°å¢é …ç›®</h3>
        
        <div class="form-group">
            <label>åç¨± (Key Name)</label>
            <input type="text" id="newKeyInput" placeholder="ä¾‹å¦‚: å›°é›£ç½®å…¥">
        </div>

        <!-- åªæœ‰ç¬¬ä¸‰å±¤æ‰é¡¯ç¤ºå…§å®¹è¼¸å…¥ -->
        <div class="form-group" id="newContentGroup" style="display:none;">
            <label>é è¨­å…§å®¹</label>
            <textarea id="newContentInput" style="height:100px;"></textarea>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="confirmAdd()">ç¢ºå®šæ–°å¢</button>
        </div>
    </div>
</div>

<!-- åå¸é€šçŸ¥ -->
<div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>

<script>
    let db = window.nursingData || {};
    let currentPath = []; // [Main, Cat, Item]
    
    // æ–°å¢ç‹€æ…‹è®Šæ•¸
    let addState = {
        level: '', // 'main', 'cat', 'item'
        parentPath: []
    };

    const treeContainer = document.getElementById('sidebarTree');
    const emptyState = document.getElementById('emptyState');
    const editorCard = document.getElementById('editorCard');
    const modalOverlay = document.getElementById('modalOverlay');

    // --- æ ¸å¿ƒï¼šæ¸²æŸ“å·¦å´æ¨¹ç‹€åœ– ---
    function renderTree() {
        treeContainer.innerHTML = '';
        
        // 1. éæ­· Main
        Object.keys(db).forEach(mainKey => {
            // Main Node
            let mainDiv = createNodeElement(mainKey, 'level-1', ['main', mainKey]);
            
            // Add Button for Main (Add Category)
            let addCatBtn = document.createElement('button');
            addCatBtn.className = 'mini-btn';
            addCatBtn.innerHTML = 'ï¼‹';
            addCatBtn.title = 'æ–°å¢åˆ†é¡';
            addCatBtn.onclick = (e) => { e.stopPropagation(); openModal('cat', [mainKey]); };
            mainDiv.querySelector('.node-actions').appendChild(addCatBtn);
            
            treeContainer.appendChild(mainDiv);

            // 2. éæ­· Category
            const cats = db[mainKey];
            Object.keys(cats).forEach(catKey => {
                let catDiv = createNodeElement(catKey, 'level-2', ['cat', mainKey, catKey]);
                
                // Add Button for Cat (Add Item)
                let addItemBtn = document.createElement('button');
                addItemBtn.className = 'mini-btn';
                addItemBtn.innerHTML = 'ï¼‹';
                addItemBtn.title = 'æ–°å¢å…§å®¹';
                addItemBtn.onclick = (e) => { e.stopPropagation(); openModal('item', [mainKey, catKey]); };
                catDiv.querySelector('.node-actions').appendChild(addItemBtn);

                treeContainer.appendChild(catDiv);

                // 3. éæ­· Items
                const items = cats[catKey];
                Object.keys(items).forEach(itemKey => {
                    let itemDiv = createNodeElement(itemKey, 'level-3', ['item', mainKey, catKey, itemKey]);
                    itemDiv.onclick = () => selectItem(mainKey, catKey, itemKey);
                    
                    // Highlight active
                    if(currentPath[2] === itemKey && currentPath[1] === catKey) {
                        itemDiv.classList.add('active');
                    }

                    treeContainer.appendChild(itemDiv);
                });
            });
        });
    }

    // å»ºç«‹ç¯€é» DOM çš„è¼”åŠ©å‡½å¼
    function createNodeElement(text, levelClass, meta) {
        let div = document.createElement('div');
        div.className = `tree-node ${levelClass}`;
        div.innerHTML = `
            <span>${text}</span>
            <div class="node-actions"></div>
        `;
        return div;
    }

    // --- é¸å–é …ç›® ---
    function selectItem(main, cat, item) {
        currentPath = [main, cat, item];
        renderTree(); // é‡ç¹ªä»¥æ›´æ–°é«˜äº®
        
        emptyState.style.display = 'none';
        editorCard.style.display = 'block';

        document.getElementById('breadcrumbPath').innerText = `${main} > ${cat}`;
        document.getElementById('editorTitle').innerText = item;
        document.getElementById('editorContent').value = db[main][cat][item];
    }

    // --- ä¿®æ”¹èˆ‡å„²å­˜ ---
    function saveCurrentItem() {
        if(currentPath.length !== 3) return;
        const [main, cat, item] = currentPath;
        const newContent = document.getElementById('editorContent').value;
        
        db[main][cat][item] = newContent;
        showToast("âœ… å·²æš«å­˜ä¿®æ”¹");
    }

    function deleteItem() {
        if(currentPath.length !== 3) return;
        const [main, cat, item] = currentPath;
        
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item}ã€å—ï¼Ÿ`)) {
            delete db[main][cat][item];
            currentPath = [];
            editorCard.style.display = 'none';
            emptyState.style.display = 'block';
            renderTree();
            showToast("ğŸ—‘ï¸ å·²åˆªé™¤");
        }
    }

    // --- æ–°å¢åŠŸèƒ½ (Modal) ---
    function openModal(level, parentPath = []) {
        addState.level = level;
        addState.parentPath = parentPath;
        
        document.getElementById('newKeyInput').value = '';
        document.getElementById('newContentInput').value = '';
        document.getElementById('modalTitle').innerText = 
            level === 'main' ? 'æ–°å¢ä¸»è™•ç½®' :
            level === 'cat' ? `åœ¨ [${parentPath[0]}] ä¸‹æ–°å¢åˆ†é¡` :
            `åœ¨ [${parentPath[1]}] ä¸‹æ–°å¢å…§å®¹`;
            
        document.getElementById('newContentGroup').style.display = (level === 'item') ? 'block' : 'none';
        
        modalOverlay.classList.add('show');
        setTimeout(()=> document.getElementById('newKeyInput').focus(), 100);
    }

    function closeModal() {
        modalOverlay.classList.remove('show');
    }

    function confirmAdd() {
        const key = document.getElementById('newKeyInput').value.trim();
        if(!key) return alert("åç¨±ä¸èƒ½ç‚ºç©º");

        if(addState.level === 'main') {
            if(!db[key]) db[key] = {};
        } 
        else if(addState.level === 'cat') {
            const [pMain] = addState.parentPath;
            if(!db[pMain][key]) db[pMain][key] = {};
        } 
        else if(addState.level === 'item') {
            const [pMain, pCat] = addState.parentPath;
            const content = document.getElementById('newContentInput').value;
            db[pMain][pCat][key] = content;
        }

        closeModal();
        renderTree();
        showToast("âœ¨ æ–°å¢æˆåŠŸ");
    }

    // --- ä¸‹è¼‰æª”æ¡ˆ ---
    function downloadDB() {
        const content = `window.nursingData = ${JSON.stringify(db, null, 4)};`;
        const blob = new Blob([content], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "database.js";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("â¬‡ï¸ æª”æ¡ˆå·²ä¸‹è¼‰ï¼Œè«‹è¦†è“‹åŸæª”");
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    window.onload = renderTree;
</script>

</body>
</html>
