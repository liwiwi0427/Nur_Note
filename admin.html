<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†è¨˜éŒ„ç®¡ç†å¾Œå°</title>
    <link rel="stylesheet" href="style.css">
    <script src="database.js"></script>
</head>
<body>

<div class="container" style="max-width: 1200px; padding: 20px;">
    <h2>âš™ï¸ è­·ç†è¨˜éŒ„è³‡æ–™åº«ç®¡ç† (Admin)</h2>
    
    <div class="admin-layout">
        <!-- å·¦å´ï¼šè³‡æ–™æ¨¹ç‹€åœ– -->
        <div class="sidebar">
            <div style="margin-bottom: 10px; display: flex; gap: 5px;">
                <button class="btn-secondary btn-sm" onclick="showAddModal('main')">+ ä¸»é …</button>
                <button class="btn-secondary btn-sm" onclick="expandAll()">å±•é–‹</button>
                <button class="btn-secondary btn-sm" onclick="collapseAll()">æ”¶åˆ</button>
            </div>
            <div id="treeView">
                <!-- Javascript æœƒè‡ªå‹•ç”¢ç”Ÿé€™è£¡çš„å…§å®¹ -->
            </div>
        </div>

        <!-- å³å´ï¼šç·¨è¼¯é¢æ¿ -->
        <div class="editor-panel">
            <div id="welcomeMessage" style="text-align: center; color: #999; margin-top: 50px;">
                <h3>ğŸ‘ˆ è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹é …ç›®é€²è¡Œç·¨è¼¯</h3>
                <p>æˆ–æ˜¯é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢è³‡æ–™</p>
            </div>

            <div id="editForm" style="display: none;">
                <div class="panel-header">
                    <h3 id="editPath" style="margin:0; color:var(--primary);">ç·¨è¼¯é …ç›®</h3>
                    <button class="btn-delete btn-sm" onclick="deleteCurrentItem()">ğŸ—‘ï¸ åˆªé™¤æ­¤é …</button>
                </div>

                <div class="form-group">
                    <label>é …ç›®åç¨± (Title)</label>
                    <input type="text" id="editKey" disabled style="background:#eee; cursor: not-allowed;">
                    <div class="hint">ç›®å‰æš«ä¸æ”¯æ´ç›´æ¥ä¿®æ”¹åç¨±ï¼Œè«‹åˆªé™¤å¾Œé‡å»ºæˆ–åƒ…ä¿®æ”¹å…§å®¹ã€‚</div>
                </div>

                <div class="form-group">
                    <label>å…§å®¹æ¨¡ç‰ˆ (Template)</label>
                    <textarea id="editValue" style="height: 200px;"></textarea>
                    <div class="hint">ä½¿ç”¨ {{è®Šæ•¸}} ä¾†å»ºç«‹å¡«ç©ºæ¬„ä½</div>
                </div>

                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn-primary" onclick="saveChanges()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œåˆ— -->
    <div style="margin-top: 20px; text-align: right; border-top: 1px solid #ccc; padding-top: 20px;">
        <button class="btn-danger" style="width: auto; display: inline-flex;" onclick="downloadDB()">
            ğŸ“¥ ä¸‹è¼‰æ›´æ–°å¾Œçš„ database.js
        </button>
        <p class="hint">ä¿®æ”¹å®Œæˆå¾Œï¼Œè«‹å‹™å¿…ä¸‹è¼‰æª”æ¡ˆä¸¦è¦†è“‹åŸæª”ï¼Œè®Šæ›´æ‰æœƒç”Ÿæ•ˆã€‚</p>
    </div>
</div>

<!-- æ–°å¢è³‡æ–™çš„å½ˆçª— -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">æ–°å¢é …ç›®</h3>
        <div class="form-group">
            <label>åç¨±ï¼š</label>
            <input type="text" id="newKeyName">
        </div>
        <!-- åªæœ‰æ–°å¢ç¬¬ä¸‰å±¤(å…§å®¹)æ™‚æ‰é¡¯ç¤ºå…§å®¹æ¡† -->
        <div class="form-group" id="newContentGroup" style="display:none;">
            <label>å…§å®¹æ¨¡ç‰ˆï¼š</label>
            <textarea id="newContentValue"></textarea>
        </div>
        <div class="btn-group" style="justify-content: flex-end;">
            <button class="btn-secondary btn-sm" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-primary btn-sm" onclick="confirmAdd()">ç¢ºå®šæ–°å¢</button>
        </div>
    </div>
</div>

<script>
    // 1. è¼‰å…¥è³‡æ–™
    let db = window.nursingData || {};
    
    // è¨˜éŒ„ç•¶å‰é¸ä¸­çš„è·¯å¾‘ [Main, Category, Title]
    let currentPath = [];
    
    // ç”¨æ–¼æ–°å¢åŠŸèƒ½çš„æš«å­˜è®Šæ•¸
    let addLevel = ''; // 'main', 'cat', 'item'
    let addParentPath = [];

    const treeView = document.getElementById('treeView');
    const editForm = document.getElementById('editForm');
    const welcomeMessage = document.getElementById('welcomeMessage');

    // 2. æ¸²æŸ“æ¨¹ç‹€åœ– (æ ¸å¿ƒåŠŸèƒ½)
    function renderTree() {
        treeView.innerHTML = '';
        
        // Level 1: Main Procedure
        Object.keys(db).forEach(mainKey => {
            const mainDetails = document.createElement('details');
            mainDetails.open = true; // é è¨­å±•é–‹ç¬¬ä¸€å±¤
            const mainSummary = document.createElement('summary');
            
            // è®“ Summary åŒ…å«æŒ‰éˆ• (æ–°å¢å­é …)
            mainSummary.innerHTML = `${mainKey} <button class="btn-secondary btn-sm" style="float:right; padding:2px 8px; font-size:10px;" onclick="event.preventDefault(); showAddModal('cat', ['${mainKey}'])">+åˆ†é¡</button>`;
            
            mainDetails.appendChild(mainSummary);

            // Level 2: Category
            const catObj = db[mainKey];
            Object.keys(catObj).forEach(catKey => {
                const catDetails = document.createElement('details');
                const catSummary = document.createElement('summary');
                catSummary.innerHTML = `${catKey} <button class="btn-secondary btn-sm" style="float:right; padding:2px 8px; font-size:10px;" onclick="event.preventDefault(); showAddModal('item', ['${mainKey}', '${catKey}'])">+å…§å®¹</button>`;
                catDetails.appendChild(catSummary);

                // Level 3: Item (Leaf)
                const itemObj = catObj[catKey];
                Object.keys(itemObj).forEach(itemKey => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'tree-item';
                    itemDiv.innerText = itemKey;
                    itemDiv.onclick = () => selectItem(mainKey, catKey, itemKey, itemDiv);
                    catDetails.appendChild(itemDiv);
                });

                mainDetails.appendChild(catDetails);
            });

            treeView.appendChild(mainDetails);
        });
    }

    // 3. é¸æ“‡é …ç›®
    function selectItem(main, cat, key, element) {
        currentPath = [main, cat, key];
        
        // UI Highlight
        document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // Show Form
        welcomeMessage.style.display = 'none';
        editForm.style.display = 'block';

        document.getElementById('editPath').innerText = `${main} > ${cat}`;
        document.getElementById('editKey').value = key;
        document.getElementById('editValue').value = db[main][cat][key];
    }

    // 4. å„²å­˜ä¿®æ”¹ (Update)
    function saveChanges() {
        if (currentPath.length !== 3) return;
        const [main, cat, key] = currentPath;
        const newValue = document.getElementById('editValue').value;

        db[main][cat][key] = newValue;
        alert('âœ… ä¿®æ”¹å·²æš«å­˜ï¼\nè¨˜å¾—æœ€å¾Œè¦é»æ“Šä¸‹æ–¹çš„ã€Œä¸‹è¼‰ã€æŒ‰éˆ•æ‰èƒ½çœŸæ­£å„²å­˜æª”æ¡ˆã€‚');
    }

    // 5. åˆªé™¤é …ç›® (Delete)
    function deleteCurrentItem() {
        if (currentPath.length !== 3) return;
        const [main, cat, key] = currentPath;
        
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${key}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) {
            delete db[main][cat][key];
            
            // å¦‚æœè©²åˆ†é¡ç©ºäº†ï¼Œæ˜¯å¦è¦åˆªé™¤åˆ†é¡ï¼Ÿé€™è£¡å…ˆä¿ç•™ç©ºåˆ†é¡
            renderTree();
            welcomeMessage.style.display = 'block';
            editForm.style.display = 'none';
        }
    }

    // 6. ä¸‹è¼‰æª”æ¡ˆ (Export)
    function downloadDB() {
        const fileContent = `window.nursingData = ${JSON.stringify(db, null, 4)};`;
        const blob = new Blob([fileContent], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "database.js";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("â¬‡ï¸ æª”æ¡ˆå·²ä¸‹è¼‰ï¼è«‹è¦†è“‹åŸæª”ã€‚");
    }

    // ===========================
    // æ–°å¢åŠŸèƒ½ (Modal Logic)
    // ===========================
    const modal = document.getElementById('addModal');
    const newContentGroup = document.getElementById('newContentGroup');

    function showAddModal(level, parentPath = []) {
        addLevel = level;
        addParentPath = parentPath;
        
        document.getElementById('newKeyName').value = '';
        document.getElementById('newContentValue').value = '';
        modal.classList.add('show');

        if (level === 'main') {
            document.getElementById('modalTitle').innerText = 'æ–°å¢ä¸»è™•ç½® (Main)';
            newContentGroup.style.display = 'none';
        } else if (level === 'cat') {
            document.getElementById('modalTitle').innerText = `åœ¨ [${parentPath[0]}] ä¸‹æ–°å¢åˆ†é¡`;
            newContentGroup.style.display = 'none';
        } else if (level === 'item') {
            document.getElementById('modalTitle').innerText = `åœ¨ [${parentPath[1]}] ä¸‹æ–°å¢å…§å®¹`;
            newContentGroup.style.display = 'block';
        }
    }

    function closeModal() {
        modal.classList.remove('show');
    }

    function confirmAdd() {
        const keyName = document.getElementById('newKeyName').value.trim();
        if (!keyName) { alert("è«‹è¼¸å…¥åç¨±"); return; }

        if (addLevel === 'main') {
            if (!db[keyName]) db[keyName] = {};
        } 
        else if (addLevel === 'cat') {
            const [main] = addParentPath;
            if (!db[main][keyName]) db[main][keyName] = {};
        } 
        else if (addLevel === 'item') {
            const [main, cat] = addParentPath;
            const content = document.getElementById('newContentValue').value;
            db[main][cat][keyName] = content;
        }

        closeModal();
        renderTree();
    }

    // è¼”åŠ©åŠŸèƒ½
    function expandAll() {
        document.querySelectorAll('details').forEach(d => d.open = true);
    }
    function collapseAll() {
        document.querySelectorAll('details').forEach(d => d.open = false);
    }

    // åˆå§‹åŒ–
    window.onload = renderTree;

</script>

</body>
</html>
