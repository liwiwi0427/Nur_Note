<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†è¨˜éŒ„ç”¢ç”Ÿå™¨</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: white;
            width: 100%;
            max-width: 600px;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box; /* Fix padding issue */
        }
        .variable-input-group {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 5px solid #3498db;
        }
        .variable-input-group h4 {
            margin-top: 0;
            color: #2980b9;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
            background-color: #fafafa;
            box-sizing: border-box;
        }
        .btn-copy {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }
        .btn-copy:hover {
            background-color: #219150;
        }
        .btn-copy:active {
            background-color: #1e8449;
        }
        /* éš±è—ç©ºè®Šæ•¸å€å¡Š */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ è­·ç†è¨˜éŒ„ç”¢ç”Ÿå™¨</h2>

    <!-- é¸å–®å€ -->
    <div class="form-group">
        <label>1. ä¸»è™•ç½® (Main Procedure)</label>
        <select id="mainSelect" onchange="updateCategory()">
            <option value="">è«‹é¸æ“‡...</option>
        </select>
    </div>

    <div class="form-group">
        <label>2. åˆ†é¡ (Category)</label>
        <select id="catSelect" onchange="updateSubCategory()" disabled>
            <option value="">è«‹å…ˆé¸æ“‡ä¸»è™•ç½®</option>
        </select>
    </div>

    <div class="form-group">
        <label>3. æ¬¡åˆ†é¡ / å…§å®¹ (Detail)</label>
        <select id="subSelect" onchange="renderVariables()" disabled>
            <option value="">è«‹å…ˆé¸æ“‡åˆ†é¡</option>
        </select>
    </div>

    <!-- å‹•æ…‹è®Šæ•¸è¼¸å…¥å€ (æœƒæ ¹æ“šå…§å®¹è‡ªå‹•ç”¢ç”Ÿ) -->
    <div id="variableContainer" class="variable-input-group hidden">
        <h4>å¡«å¯«è¦æ ¼/æ•¸å€¼ï¼š</h4>
        <div id="dynamicInputs"></div>
    </div>

    <!-- çµæœå€ -->
    <div class="form-group">
        <label>é è¦½çµæœ (å¯ç›´æ¥ç·¨è¼¯)</label>
        <textarea id="resultArea"></textarea>
    </div>

    <button class="btn-copy" onclick="copyText()">è¤‡è£½è¨˜éŒ„</button>
</div>

<script>
    // ==========================================
    // è³‡æ–™è¨­å®šå€ (è«‹åœ¨æ­¤è™•ä¿®æ”¹ä½ çš„è­·ç†è¨˜éŒ„å…§å®¹)
    // æ ¼å¼ï¼š {{è®Šæ•¸åç¨±}} ä»£è¡¨éœ€è¦å¡«å¯«çš„åœ°æ–¹
    // ==========================================
    const nursingData = {
        "Foley (å°å°¿ç®¡)": {
            "ç½®å…¥ (Insertion)": {
                "ä¸€èˆ¬ç½®å…¥": "Indwelling Foley catheter size {{å°ºå¯¸}} Fr inserted smoothly with urine output {{å°¿é‡}} ml, clear/yellow color. Balloon fixed with {{æ°´çƒæ°´é‡}} ml distilled water.",
                "å›°é›£ç½®å…¥": "Tried to insert Foley size {{å°ºå¯¸}} Fr but failed due to resistance. Consulted Urologist for further evaluation."
            },
            "è­·ç† (Care)": {
                "ä¸€èˆ¬è­·ç†": "Foley care done with aqueous beta-iodine. Urine clear, patent flow. Fixed on {{å›ºå®šä½ç½®}} thigh.",
                "ç§»é™¤": "Foley catheter removed smoothly. Tip intact. Instructed patient to monitor urination."
            }
        },
        "NG Tube (é¼»èƒƒç®¡)": {
            "ç½®å…¥": {
                "ä¸€èˆ¬ç½®å…¥": "NG tube size {{å°ºå¯¸}} Fr inserted via {{å·¦/å³}} nostril up to {{å…¬åˆ†}} cm. Confirmed placement by auscultation. Fixed properly.",
                "æ›´æ›": "Old NG tube removed. New NG tube size {{å°ºå¯¸}} Fr inserted up to {{å…¬åˆ†}} cm."
            },
            "çŒé£Ÿ": {
                "åæŠ½": "Checked NG tube placement, negative specific signs. Regurgitation: {{åæŠ½é‡}} ml. Color: {{é¡è‰²}}.",
                "ä¸€èˆ¬çŒé£Ÿ": "Feeding formula {{é…æ–¹åç¨±}} {{æ¯«å‡}} ml given via NG tube. Tolerated well, no vomiting."
            }
        },
        "IV (éœè„ˆæ³¨å°„)": {
            "å»ºç«‹": {
                "ä¸€èˆ¬": "IV cath size {{é‡é ­å°ºå¯¸}} G set on {{éƒ¨ä½}}. Fixed with tegaderm. Patent flow."
            }
        }
    };

    // ==========================================
    // ç¨‹å¼é‚è¼¯å€
    // ==========================================
    const mainSelect = document.getElementById('mainSelect');
    const catSelect = document.getElementById('catSelect');
    const subSelect = document.getElementById('subSelect');
    const variableContainer = document.getElementById('variableContainer');
    const dynamicInputs = document.getElementById('dynamicInputs');
    const resultArea = document.getElementById('resultArea');

    let currentTemplate = "";

    // 1. åˆå§‹åŒ–é é¢ï¼Œè¼‰å…¥ç¬¬ä¸€å±¤é¸å–®
    window.onload = function() {
        for (let key in nursingData) {
            let option = document.createElement("option");
            option.value = key;
            option.text = key;
            mainSelect.appendChild(option);
        }
    };

    // 2. ç¬¬ä¸€å±¤æ”¹è®Šï¼Œæ›´æ–°ç¬¬äºŒå±¤
    function updateCategory() {
        catSelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†é¡...</option>';
        subSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åˆ†é¡</option>';
        subSelect.disabled = true;
        catSelect.disabled = false;
        variableContainer.classList.add('hidden');
        resultArea.value = "";

        let mainVal = mainSelect.value;
        if (mainVal && nursingData[mainVal]) {
            for (let key in nursingData[mainVal]) {
                let option = document.createElement("option");
                option.value = key;
                option.text = key;
                catSelect.appendChild(option);
            }
        }
    }

    // 3. ç¬¬äºŒå±¤æ”¹è®Šï¼Œæ›´æ–°ç¬¬ä¸‰å±¤
    function updateSubCategory() {
        subSelect.innerHTML = '<option value="">è«‹é¸æ“‡å…§å®¹...</option>';
        subSelect.disabled = false;
        variableContainer.classList.add('hidden');
        resultArea.value = "";

        let mainVal = mainSelect.value;
        let catVal = catSelect.value;

        if (mainVal && catVal && nursingData[mainVal][catVal]) {
            let subData = nursingData[mainVal][catVal];
            for (let key in subData) {
                let option = document.createElement("option");
                option.value = subData[key]; // é€™è£¡æŠŠå…§å®¹ç•¶ä½œ value
                option.text = key;           // æ¨™é¡Œé¡¯ç¤ºåœ¨é¸å–®
                subSelect.appendChild(option);
            }
        }
    }

    // 4. ç¬¬ä¸‰å±¤æ”¹è®Šï¼Œè§£æè®Šæ•¸ {{...}} ä¸¦ç”¢ç”Ÿè¼¸å…¥æ¡†
    function renderVariables() {
        dynamicInputs.innerHTML = "";
        currentTemplate = subSelect.value;
        resultArea.value = currentTemplate; // å…ˆé¡¯ç¤ºåŸå§‹æ¨£æ¿

        if (!currentTemplate) {
            variableContainer.classList.add('hidden');
            return;
        }

        // ä½¿ç”¨ Regex å°‹æ‰¾æ‰€æœ‰ {{æ–‡å­—}}
        const regex = /{{(.*?)}}/g;
        let match;
        let hasVariables = false;

        // é¿å…é‡è¤‡è®Šæ•¸IDè¡çªï¼Œä½¿ç”¨Set
        let uniqueVars = new Set();
        
        while ((match = regex.exec(currentTemplate)) !== null) {
            uniqueVars.add(match[1]); // æŠ“å–æ‹¬è™Ÿå…§çš„æ–‡å­—
            hasVariables = true;
        }

        if (hasVariables) {
            variableContainer.classList.remove('hidden');
            uniqueVars.forEach(varName => {
                // å»ºç«‹è¼¸å…¥æ¡† UI
                let div = document.createElement("div");
                div.style.marginBottom = "10px";
                
                let label = document.createElement("label");
                label.innerText = varName + " :";
                label.style.fontSize = "14px";
                
                let input = document.createElement("input");
                input.type = "text";
                input.placeholder = "è¼¸å…¥" + varName;
                input.dataset.varName = varName; // ç¶å®šè®Šæ•¸å
                input.oninput = generateFinalText; // è¼¸å…¥æ™‚å³æ™‚æ›´æ–°

                div.appendChild(label);
                div.appendChild(input);
                dynamicInputs.appendChild(div);
            });
            // ç¬¬ä¸€æ¬¡ç”Ÿæˆå®Œï¼ŒåŸ·è¡Œä¸€æ¬¡æ›¿æ›ä»¥æ¸…é™¤æ‹¬è™Ÿ(å¦‚æœä½¿ç”¨è€…é‚„æ²’è¼¸å…¥)
            generateFinalText();
        } else {
            variableContainer.classList.add('hidden');
        }
    }

    // 5. æ ¹æ“šè¼¸å…¥æ¡†å…§å®¹ï¼Œçµ„è£æœ€çµ‚æ–‡å­—
    function generateFinalText() {
        let tempText = currentTemplate;
        const inputs = dynamicInputs.querySelectorAll("input");

        inputs.forEach(input => {
            const key = input.dataset.varName;
            const value = input.value;
            // å¦‚æœæœ‰è¼¸å…¥å€¼ï¼Œå°±æ›¿æ›ï¼›å¦‚æœæ²’æœ‰ï¼Œä¿ç•™ {{key}} æç¤ºä½¿ç”¨è€…æˆ–æ˜¯æ›¿æ›æˆç©º
            // é€™è£¡è¨­å®šï¼šè‹¥æœªè¼¸å…¥ï¼Œä¿ç•™åŸæ¨£æ–¹ä¾¿è­˜åˆ¥ï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹æˆ replace ç‚º "___"
            if (value) {
                // replaceAll ç¢ºä¿åŒä¸€å€‹è®Šæ•¸å‡ºç¾å¤šæ¬¡ä¹Ÿèƒ½å…¨éƒ¨æ›æ‰
                tempText = tempText.split(`{{${key}}}`).join(value);
            }
        });

        resultArea.value = tempText;
    }

    // 6. è¤‡è£½åŠŸèƒ½
    function copyText() {
        const copyText = document.getElementById("resultArea");
        
        if (!copyText.value) {
            alert("æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½ï¼");
            return;
        }

        copyText.select();
        copyText.setSelectionRange(0, 99999); /* æ‰‹æ©Ÿç‰ˆå…¼å®¹ */

        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        }).catch(err => {
            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
        });
    }
</script>

</body>
</html>
