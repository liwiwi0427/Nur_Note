<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>護理記錄快手</title>
    <!-- 1. 引入樣式表 -->
    <link rel="stylesheet" href="style.css">
    <!-- 2. 引入資料庫 -->
    <script src="database.js"></script>
</head>
<body>

<div class="container">
    <h1>🏥 護理記錄產生器</h1>

    <div class="form-group">
        <div class="section-title">Step 1: 選擇項目</div>
        <div class="row">
            <select id="mainSelect" onchange="updateCategory()">
                <option value="">主處置...</option>
            </select>
            <select id="catSelect" onchange="updateSubCategory()" disabled>
                <option value="">分類...</option>
            </select>
        </div>
        <div style="margin-top: 15px;">
            <select id="subSelect" onchange="renderVariables()" disabled>
                <option value="">詳細內容...</option>
            </select>
        </div>
    </div>

    <!-- 動態變數區 (預設隱藏) -->
    <div id="variableArea" style="display:none;">
        <div class="section-title">Step 2: 填寫數據</div>
        <div id="dynamicInputs"></div>
    </div>

    <div class="form-group">
        <div class="section-title">Step 3: 預覽與修改</div>
        <textarea id="resultArea" placeholder="系統將自動生成記錄..."></textarea>
    </div>

    <button class="btn-primary" onclick="copyText()">📋 複製到剪貼簿</button>
</div>

<div id="toast" class="toast">✅ 已複製成功！</div>

<script>
    function renderVariables() {
        dynamicInputs.innerHTML = '';
        currentTemplate = subSelect.value;
        resultArea.value = currentTemplate;

        if (!currentTemplate) {
            variableArea.style.display = 'none';
            return;
        }

        // 1. 抓取所有 {{...}} 內容
        const regex = /{{(.*?)}}/g;
        let match;
        const vars = new Set(); // 用 Set 避免重複抓取相同變數
        
        while ((match = regex.exec(currentTemplate)) !== null) {
            vars.add(match[1]); // match[1] 會抓到 "顏色|紅|黃" 這樣的完整字串
        }

        if (vars.size > 0) {
            variableArea.style.display = 'block';
            
            vars.forEach(tagContent => {
                const div = document.createElement('div');
                div.style.marginBottom = "15px";

                // 2. 判斷是否有 '|' 符號
                if (tagContent.includes('|')) {
                    // === 下拉選單模式 ===
                    const parts = tagContent.split('|');
                    const labelName = parts[0]; // 第一個是標題
                    const options = parts.slice(1); // 剩下的是選項

                    let label = document.createElement('label');
                    label.innerText = labelName;
                    
                    let select = document.createElement('select');
                    select.dataset.originalTag = tagContent; // 記住原始標籤以便替換
                    select.onchange = generateText; // 改變時觸發更新

                    // 加入一個預設提示選項
                    let defaultOpt = document.createElement('option');
                    defaultOpt.text = `(請選擇${labelName})`;
                    defaultOpt.value = ""; 
                    // defaultOpt.selected = true; // 預設選中
                    select.appendChild(defaultOpt);

                    options.forEach(optText => {
                        let option = document.createElement('option');
                        option.value = optText;
                        option.text = optText;
                        select.appendChild(option);
                    });

                    div.appendChild(label);
                    div.appendChild(select);

                } else {
                    // === 原本的文字輸入框模式 ===
                    let label = document.createElement('label');
                    label.innerText = tagContent;
                    
                    let input = document.createElement('input');
                    input.type = "text";
                    input.dataset.originalTag = tagContent; // 記住原始標籤
                    input.placeholder = "輸入" + tagContent + "...";
                    input.oninput = generateText;

                    div.appendChild(label);
                    div.appendChild(input);
                }

                dynamicInputs.appendChild(div);
            });
            
            // 如果只有文字框，自動聚焦第一個
            const firstInput = dynamicInputs.querySelector('input');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);

        } else {
            variableArea.style.display = 'none';
        }
    }

    function generateText() {
        let text = currentTemplate;
        
        // 抓取所有的 input 和 select
        const inputs = dynamicInputs.querySelectorAll('input, select');
        
        inputs.forEach(el => {
            const originalTag = el.dataset.originalTag; // 取得 "顏色|紅|黃"
            const val = el.value;

            // 如果使用者有輸入或選擇，就進行替換
            if (val) {
                // 使用 replaceAll 確保重複出現的變數都會被換掉
                // 我們要替換的是整個 {{顏色|紅|黃}}
                text = text.split(`{{${originalTag}}}`).join(val);
            }
        });
        
        resultArea.value = text;
    }

    // ...後面 copyText 等其他函式維持原樣...
2. 如何在資料庫 (database.js) 中使用？
現在你可以去修改你的 database.js，加入選項了。
範例：
code
JavaScript
window.nursingData = {
    "管路處置": {
        "Foley": {
            "一般置入": "導尿管置入，規格：{{Size}} Fr，材質：{{材質|矽膠|橡膠}}，尿液顏色：{{顏色|淡黃|茶色|血色}}，性質：{{性質|澄清|混濁}}。"
        }
    },
    "評估": {
        "意識": {
            "GCS": "意識狀態：E {{E|4|3|2|1}} V {{V|5|4|3|2|1|T}} M {{M|6|5|4|3|2|1}}，瞳孔反射：{{瞳孔|++/++|+-/+-|--/--}}。"
        }
    }
};
